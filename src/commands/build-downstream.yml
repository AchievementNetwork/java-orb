description: >
  Build downstream project

parameters:
  project:
    description: >
      The name(s) of the downstream project(s) to build.
      If providing multiple names they should be space separated.
    type: string
  branch:
    description: >
      The branch of the project(s) to build.
      The same branch will be used for all projects specified.
    type: string
    default: dev
  api-token:
    description: The token used to authorise the CircleCI build
    type: env_var_name
    default: CIRCLECI_API_TOKEN

steps:
  - run:
      name: Starting downstream build
      command: |
        for project in <<parameters.project>>; do
          CIRCLE_JOB_INFO=$(curl -X POST \
            --silent \
            --header "Circle-Token: ${<<parameters.api-token>>}" \
            --header 'Accept: text/plain' \
            --header 'Content-Type: application/json' \
            --data '{"branch":"<<parameters.branch>>"}' \
            https://circleci.com/api/v2/project/gh/AchievementNetwork/$project/pipeline)
          echo $CIRCLE_JOB_INFO
          echo $CIRCLE_JOB_INFO | grep "id" 2>&1 > /dev/null
        done
